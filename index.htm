<html>
<head>
	<title>Hej</title>
	<script>
	var FPS = 30;
	var RENDERTIME = 1000 / FPS; // Milliseconds
	var RADIUS = Math.PI / 50;
	var worms = [];
	var canvasid;
	var canvas1, canvas2, ctx1, ctx2, ctx, activectx;
	
	Array.prototype.last = function() {return this[this.length-1];};
	
	function worm() {
		this.turning = 0;
		this.alive = true;
		this.positions = [{'x': Math.random()*canvas1.width, 'y': Math.random()*canvas1.height}];
		this.color = '#'+ Math.floor(Math.random()*10) + Math.floor(Math.random()*10) + Math.floor(Math.random()*10);
		this.width = 4;
		this.d = Math.random()*2*Math.PI; // Direction in radians. Unit circle.
	}

	
	function init() {
		canvas1 = document.getElementById("canvas1");
		canvas2 = document.getElementById("canvas2");

		ctx1 = canvas1.getContext("2d");
		ctx1.width = canvas1.width;
		ctx1.height = canvas1.height;
		
		ctx2 = canvas2.getContext("2d");
		ctx2.width = canvas2.width;
		ctx2.height = canvas2.height;
		
		canvasid = 1;
		ctx = ctx1;
		activectx = ctx2;
		
		worms.push(new worm());
		worms.push(new worm());
		
		window.onkeydown = function(e) {
			if (e.keyCode == 37) {
				worms[0].turning = -1;
			}
			else if (e.keyCode == 39) {
				worms[0].turning = 1;
			}
			else if (e.keyCode == 65) {
				worms[1].turning = -1;
			}
			else if (e.keyCode == 83) {
				worms[1].turning = 1;
			}
		};
		
		window.onkeyup = function(e) {
			if (e.keyCode == 37 || e.keyCode == 39) {
				worms[0].turning = 0;
			}
			if (e.keyCode == 65 || e.keyCode == 83) {
				worms[1].turning = 0;
			}
		};
		
		setInterval(render, RENDERTIME);
	}
	
	function render() {
		ctx.clearRect(0, 0, ctx.width, ctx.height);

		worms.forEach(function(worm) {
			var positions = worm.positions;
			if (worm.alive) {
	
				worm.d += worm.turning * RADIUS;
			
				var newx = positions.last()['x'] + Math.cos(worm.d) * 2;
				var newy = positions.last()['y'] + Math.sin(worm.d) * 2;
				
				if(newx < 0 || newy < 0 || newx > ctx.width || newy > ctx.height) {
					worm.alive = false;
				}

				data = activectx.getImageData(newx, newy, 1, 1).data;

				for(var i in data) {
						if(data[i] > 0) {
							worm.alive = false;
							break;
						}
				}
				
				worm.positions.push({'x': newx, 'y': newy});
			}

			
			var x = positions[0]['x'];
			var y = positions[0]['y'];
			
			ctx.beginPath();
			ctx.moveTo(x, y);

			worm.positions.forEach(function(coordinates) {
				ctx.lineTo(coordinates['x'], coordinates['y']);
			});

			ctx.strokeStyle = worm.color;
			ctx.lineWidth = worm.width;
			ctx.stroke();
		});

		if (canvasid == 1) {
			ctx = ctx2;
			canvas1.style.zindex = 100;
			canvas2.style.zindex = 10;
			canvasid = 2;
			activectx = ctx1;
		}
		else {
			ctx = ctx1;
			canvas2.style.zindex = 100;
			canvas1.style.zindex = 10;
			canvasid = 1;
			activectx = ctx2;
		}
	}
	
	window.onload = init;
	</script>
	<style>
		canvas {
			position: absolute;
			top: 0px;
			left: 0px;
			z-index: 50;
		}
	</style>
</head>
<body>
	<canvas width="500" height="500" id="canvas1" style="border: 1px solid grey;"></canvas>
	<canvas width="500" height="500" id="canvas2" style="border: 1px solid grey;"></canvas>
</body>

</html>
